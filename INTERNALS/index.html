
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://maximepires4.github.io/mp-neural-network/INTERNALS/">
      
      
        <link rel="prev" href="../USER_GUIDE/">
      
      
        <link rel="next" href="../OPTIMIZATION_GUIDE/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Architecture & Internals - MPNeuralNetwork</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.618322db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#architecture-internals" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="MPNeuralNetwork" class="md-header__button md-logo" aria-label="MPNeuralNetwork" data-md-component="logo">
      
  <img src="../assets/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            MPNeuralNetwork
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Architecture & Internals
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/maximepires4/mp-neural-network" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="MPNeuralNetwork" class="md-nav__button md-logo" aria-label="MPNeuralNetwork" data-md-component="logo">
      
  <img src="../assets/logo.svg" alt="logo">

    </a>
    MPNeuralNetwork
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/maximepires4/mp-neural-network" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../USER_GUIDE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    User Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Architecture & Internals
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture & Internals
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-design-philosophy-solid" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Design Philosophy (SOLID)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Design Philosophy (SOLID)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#decoupling-layers-optimizers-srp" class="md-nav__link">
    <span class="md-ellipsis">
      
        Decoupling Layers &amp; Optimizers (SRP)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unified-optimizer-design-adam-vs-adamw" class="md-nav__link">
    <span class="md-ellipsis">
      
        Unified Optimizer Design (Adam vs AdamW)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-smart-weight-initialization" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Smart Weight Initialization
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Smart Weight Initialization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-problem" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Problem
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-solution" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Solution
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-training-loop-automation" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Training Loop Automation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Training Loop Automation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#auto-validation-split" class="md-nav__link">
    <span class="md-ellipsis">
      
        Auto-Validation Split
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#early-stopping-checkpointing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Early Stopping &amp; Checkpointing
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-backend-abstraction-cpugpu" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Backend Abstraction (CPU/GPU)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Backend Abstraction (CPU/GPU)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-xp-abstraction" class="md-nav__link">
    <span class="md-ellipsis">
      
        The xp Abstraction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#device-transfers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Device Transfers
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-backend-optimizations" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Backend Optimizations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Backend Optimizations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vectorization-im2col" class="md-nav__link">
    <span class="md-ellipsis">
      
        Vectorization &amp; im2col
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-management-float32" class="md-nav__link">
    <span class="md-ellipsis">
      
        Memory Management (Float32)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-numerical-stability" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Numerical Stability
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Numerical Stability">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#logits-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Logits Handling
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-smart-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Smart Metrics
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../OPTIMIZATION_GUIDE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Optimization Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../QUALITY_GUIDE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quality Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ROADMAP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Roadmap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference/model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Model
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference/layers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Layers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference/activations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Activations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference/losses/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Losses
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference/optimizers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Optimizers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference/metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Metrics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference/serialization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Serialization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference/backend/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Backend
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-design-philosophy-solid" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Design Philosophy (SOLID)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Design Philosophy (SOLID)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#decoupling-layers-optimizers-srp" class="md-nav__link">
    <span class="md-ellipsis">
      
        Decoupling Layers &amp; Optimizers (SRP)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unified-optimizer-design-adam-vs-adamw" class="md-nav__link">
    <span class="md-ellipsis">
      
        Unified Optimizer Design (Adam vs AdamW)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-smart-weight-initialization" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Smart Weight Initialization
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Smart Weight Initialization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-problem" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Problem
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-solution" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Solution
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-training-loop-automation" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Training Loop Automation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Training Loop Automation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#auto-validation-split" class="md-nav__link">
    <span class="md-ellipsis">
      
        Auto-Validation Split
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#early-stopping-checkpointing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Early Stopping &amp; Checkpointing
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-backend-abstraction-cpugpu" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Backend Abstraction (CPU/GPU)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Backend Abstraction (CPU/GPU)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-xp-abstraction" class="md-nav__link">
    <span class="md-ellipsis">
      
        The xp Abstraction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#device-transfers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Device Transfers
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-backend-optimizations" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Backend Optimizations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Backend Optimizations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vectorization-im2col" class="md-nav__link">
    <span class="md-ellipsis">
      
        Vectorization &amp; im2col
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-management-float32" class="md-nav__link">
    <span class="md-ellipsis">
      
        Memory Management (Float32)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-numerical-stability" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Numerical Stability
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Numerical Stability">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#logits-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Logits Handling
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-smart-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Smart Metrics
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="architecture-internals">Architecture &amp; Internals</h1>
<p>MPNeuralNetwork is not just a collection of matrix operations. It includes a lightweight "engine" that automates many of the tedious and error-prone aspects of Deep Learning configuration, built upon a modular architecture.</p>
<p>This guide explains the design decisions and the "magic" happening under the hood.</p>
<hr />
<h2 id="1-design-philosophy-solid">1. Design Philosophy (SOLID)</h2>
<h3 id="decoupling-layers-optimizers-srp">Decoupling Layers &amp; Optimizers (SRP)</h3>
<p>To avoid "God Classes", the responsibility of <strong>calculating gradients</strong> from <strong>updating parameters</strong> is strictly separated.</p>
<ul>
<li><strong>The Layer's Job:</strong> It computes <code>dE/dW</code> (gradient) during the backward pass and stores it. It knows <em>nothing</em> about learning rates or update rules.</li>
<li><strong>The Optimizer's Job:</strong> The Optimizer class iterates over the layers, retrieves parameters via the generic <code>layer.params</code> property, and applies the update rule (keeping track of momentum/velocity if needed).</li>
</ul>
<h3 id="unified-optimizer-design-adam-vs-adamw">Unified Optimizer Design (Adam vs AdamW)</h3>
<p>A common confusion in Deep Learning libraries is the difference between <strong>Adam + L2 Regularization</strong> and <strong>AdamW</strong> (Decoupled Weight Decay).</p>
<ul>
<li><strong>Standard Approach:</strong> Usually, L2 regularization is added to the loss function, meaning its gradient is added to the backpropagated gradient. In adaptive methods like Adam, this means the regularization term is effectively scaled by the inverse of the gradient variance, which can be suboptimal.</li>
<li><strong>MPNN Implementation:</strong></li>
<li><strong>L1 Regularization</strong> follows the standard approach (added to gradients) to promote sparsity.</li>
<li><strong>L2 Regularization</strong> is implemented as <strong>Decoupled Weight Decay (AdamW)</strong>. The decay is applied directly to the weights <em>after</em> the adaptive update step.</li>
</ul>
<p>This design means that by simply setting <code>optimizer=Adam(regularization='L2')</code>, you are effectively using <strong>AdamW</strong>, the state-of-the-art optimizer for training modern deep networks.</p>
<hr />
<h2 id="2-smart-weight-initialization">2. Smart Weight Initialization</h2>
<p>One of the most common reasons for a neural network failing to converge is improper weight initialization.</p>
<h3 id="the-problem">The Problem</h3>
<ul>
<li><strong>Sigmoid/Tanh</strong> activations require weights to be small to avoid saturation (vanishing gradients).</li>
<li><strong>ReLU</strong> units require slightly larger weights to maintain variance (avoiding dead neurons).</li>
</ul>
<h3 id="the-solution">The Solution</h3>
<p>The <code>Model</code> class performs a <strong>static analysis</strong> of your architecture before training begins. It looks at the connection between layers to decide the optimal initialization strategy.</p>
<ul>
<li><strong>He Initialization (Kaiming):</strong> Applied if the layer is followed by <code>ReLU</code>, <code>PReLU</code>, or <code>Swish</code>.</li>
<li><strong>Xavier Initialization (Glorot):</strong> Applied if the layer is followed by <code>Sigmoid</code>, <code>Tanh</code>, or <code>Softmax</code>.</li>
<li><strong>Bias Disabling:</strong> If a <code>Dense</code> or <code>Convolutional</code> layer is immediately followed by <code>BatchNormalization</code>, the bias of the preceding layer is automatically disabled (set to <code>False</code>), as normalization makes it redundant.</li>
</ul>
<pre><code class="language-python"># Example of implicit automation
model = Model([
    Dense(100, input_size=784),  # Engine detects ReLU next -&gt; Uses He Init
    ReLU(),
    Dense(10)                    # Engine detects nothing/Softmax next -&gt; Uses Xavier
])
</code></pre>
<hr />
<h2 id="3-training-loop-automation">3. Training Loop Automation</h2>
<p>The <code>Model.train()</code> method encapsulates a production-grade training loop with several automated features.</p>
<h3 id="auto-validation-split">Auto-Validation Split</h3>
<p>Instead of manually slicing your NumPy arrays, you can pass <code>auto_evaluation=0.2</code>.</p>
<ul>
<li>The engine shuffles the data.</li>
<li>It reserves the last 20% for validation.</li>
<li>It ensures no data leakage between training and validation sets.</li>
</ul>
<h3 id="early-stopping-checkpointing">Early Stopping &amp; Checkpointing</h3>
<p>The model monitors the validation loss at every epoch.</p>
<ul>
<li><strong>Patience:</strong> If the loss doesn't improve for <code>early_stopping</code> epochs, training halts to prevent overfitting.</li>
<li><strong>Best Weight Restoration:</strong> Crucially, the model keeps a copy of the weights that achieved the <em>lowest validation loss</em>. When training ends (naturally or via early stopping), these "best weights" are automatically restored. You never end up with the overfitted weights from the final epoch.</li>
</ul>
<hr />
<h2 id="4-backend-abstraction-cpugpu">4. Backend Abstraction (CPU/GPU)</h2>
<p>To support both CPU and GPU execution without code duplication, MPNeuralNetwork implements a unified backend interface.</p>
<h3 id="the-xp-abstraction">The <code>xp</code> Abstraction</h3>
<p>The library defines a global <code>xp</code> module alias that points to either:</p>
<ul>
<li><code>numpy</code> (for CPU execution)</li>
<li><code>cupy</code> (for NVIDIA GPU execution)</li>
</ul>
<p>All tensor operations (creation, math, reshaping) use <code>xp.array</code>, <code>xp.dot</code>, etc., instead of hardcoded <code>np.*</code> calls.</p>
<h3 id="device-transfers">Device Transfers</h3>
<p>The <code>model</code> and <code>data</code> must reside on the same device.</p>
<ul>
<li><code>to_device(array)</code>: Moves a NumPy array to the configured device (GPU if enabled).</li>
<li><code>to_host(array)</code>: Moves a device array back to CPU (NumPy) for printing or saving.</li>
</ul>
<hr />
<h2 id="5-backend-optimizations">5. Backend Optimizations</h2>
<h3 id="vectorization-im2col">Vectorization &amp; <code>im2col</code></h3>
<p>Python loops are too slow for Deep Learning. MPNN vectorizes operations to leverage BLAS/LAPACK routines via NumPy.</p>
<ul>
<li><strong>Batch Processing:</strong> All layers operate on 3D/4D tensors <code>(Batch_Size, ...)</code>, eliminating the outer loop over samples.</li>
<li><strong>Convolution via <code>im2col</code>:</strong></li>
<li>2D Convolutions are difficult to vectorize directly.</li>
<li><strong>Solution:</strong> implementation of <code>im2col</code> (Image to Column), which stretches image patches into columns.</li>
<li>This transforms the convolution operation into a single, massive Matrix Multiplication (<code>GEMM</code>).</li>
<li><strong>Result:</strong> Orders of magnitude faster than iterative sliding windows.</li>
</ul>
<h3 id="memory-management-float32">Memory Management (Float32)</h3>
<p>By default, Python and NumPy use <code>float64</code> (double precision). Deep Learning rarely needs this precision.</p>
<ul>
<li>The framework enforces <code>DTYPE = np.float32</code> globally.</li>
<li>Inputs are automatically cast to float32.</li>
<li>This reduces RAM usage by <strong>50%</strong> and doubles memory bandwidth throughput.</li>
</ul>
<hr />
<h2 id="5-numerical-stability">5. Numerical Stability</h2>
<h3 id="logits-handling">Logits Handling</h3>
<p>Calculating <code>Softmax</code> then <code>CrossEntropy</code> separately is numerically unstable (can lead to <code>NaN</code> or <code>Infinity</code> due to exponentials).</p>
<ul>
<li>MPNN uses the "Logits" pattern.</li>
<li>The <code>CategoricalCrossEntropy</code> and <code>BinaryCrossEntropy</code> losses expect raw outputs (logits) from the final layer, not probabilities.</li>
<li>They internally compute the loss using the log-sum-exp trick or equivalent stable formulas.</li>
</ul>
<p><em>Note: When you call <code>model.predict()</code>, the engine automatically applies the final activation (Softmax/Sigmoid) so you get human-readable probabilities.</em></p>
<h2 id="6-smart-metrics">6. Smart Metrics</h2>
<p>To reduce boilerplate, the framework automatically assigns relevant metrics if the user doesn't specify any.</p>
<ul>
<li><strong>Regression (MSE):</strong> Automatically tracks <code>RMSE</code> and <code>R2Score</code>.</li>
<li><strong>Classification (CrossEntropy):</strong> Automatically tracks <code>Accuracy</code> and <code>F1Score</code>.</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.sections", "content.code.copy", "navigation.top", "toc.follow"], "search": "../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>